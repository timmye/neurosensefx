<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canvas Debug Test</title>
    <style>
        body {
            font-family: monospace;
            margin: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .test-area {
            border: 2px solid #333;
            width: 800px;
            height: 600px;
            position: relative;
            margin: 20px 0;
            background: #2a2a2a;
        }
        .info {
            background: #333;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border-radius: 4px;
        }
        button:hover { background: #45a049; }
        .log {
            background: #222;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>üîç Canvas Visibility Debug Test</h1>

    <div class="info">
        <strong>Testing:</strong> http://localhost:5174
        <br><strong>Issue:</strong> Canvas elements created but not visible
        <br><strong>Status:</strong> <span id="status">Loading...</span>
    </div>

    <button onclick="testWindowAccess()">Test Window Access</button>
    <button onclick="testCanvasCreation()">Test Canvas Creation</button>
    <button onclick="inspectDOM()">Inspect DOM</button>
    <button onclick="clearLog()">Clear Log</button>

    <div class="log" id="log"></div>

    <div class="test-area" id="testArea">
        <p style="padding: 20px; color: #888;">Canvas elements should appear here if created successfully</p>
    </div>

    <script>
        const log = document.getElementById('log');
        const status = document.getElementById('status');
        const testArea = document.getElementById('testArea');

        function logMessage(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff6b6b' : type === 'success' ? '#51cf66' : '#74c0fc';
            log.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            log.scrollTop = log.scrollHeight;
            console.log(`[DEBUGGER:TEST] ${message}`);
        }

        function testWindowAccess() {
            logMessage('Testing window access to the main application...');

            // Try to access the main application window
            const mainApp = window.open('http://localhost:5174', 'mainApp', 'width=800,height=600');

            if (mainApp) {
                logMessage('‚úÖ Opened main application window', 'success');

                // Wait for app to load, then test for createTestCanvas
                setTimeout(() => {
                    try {
                        if (typeof mainApp.createTestCanvas === 'function') {
                            logMessage('‚úÖ createTestCanvas function is available', 'success');

                            // Test canvas creation
                            const displayId = mainApp.createTestCanvas('EURUSD', 200, 200);
                            logMessage(`‚úÖ Created display with ID: ${displayId}`, 'success');

                            // Check for canvas elements
                            setTimeout(() => {
                                const canvases = mainApp.document.querySelectorAll('canvas');
                                logMessage(`Found ${canvases.length} canvas elements in main app`, 'info');

                                canvases.forEach((canvas, i) => {
                                    const rect = canvas.getBoundingClientRect();
                                    const style = mainApp.getComputedStyle(canvas);
                                    logMessage(`Canvas ${i+1}: ${rect.width}x${rect.height}, visible: ${style.display !== 'none' && style.visibility !== 'hidden'}`, 'info');
                                });
                            }, 2000);

                        } else {
                            logMessage('‚ùå createTestCanvas function not found - fixes may not be loaded', 'error');
                        }
                    } catch (error) {
                        logMessage(`‚ùå Error accessing main app functions: ${error.message}`, 'error');
                    }
                }, 3000);

            } else {
                logMessage('‚ùå Failed to open main application window (popup blocker?)', 'error');
                logMessage('Alternative: Manual testing required', 'info');
            }
        }

        function testCanvasCreation() {
            logMessage('Testing manual canvas creation in this debug window...');

            try {
                // Create a simple canvas to test rendering
                const canvas = document.createElement('canvas');
                canvas.width = 400;
                canvas.height = 300;
                canvas.style.border = '2px solid #4CAF50';
                canvas.style.position = 'absolute';
                canvas.style.left = '200px';
                canvas.style.top = '150px';
                canvas.style.background = '#333';

                const ctx = canvas.getContext('2d');

                // Test basic rendering
                ctx.fillStyle = '#4CAF50';
                ctx.fillRect(50, 50, 100, 100);
                ctx.fillStyle = '#fff';
                ctx.font = '16px monospace';
                ctx.fillText('Test Canvas', 60, 100);

                testArea.appendChild(canvas);
                logMessage('‚úÖ Manual test canvas created successfully', 'success');

                // Test DPR rendering
                const dpr = window.devicePixelRatio || 1;
                logMessage(`Device Pixel Ratio: ${dpr}`, 'info');

                // Transform matrix test
                const transform = ctx.getTransform();
                logMessage(`Initial transform: [${transform.a}, ${transform.b}, ${transform.c}, ${transform.d}, ${transform.e}, ${transform.f}]`, 'info');

                ctx.save();
                ctx.scale(2, 2);
                ctx.fillStyle = '#ff6b6b';
                ctx.fillRect(25, 25, 50, 50);
                ctx.restore();

                const afterTransform = ctx.getTransform();
                logMessage(`After restore transform: [${afterTransform.a}, ${afterTransform.b}, ${afterTransform.c}, ${afterTransform.d}, ${afterTransform.e}, ${afterTransform.f}]`, 'info');

                // Test the transform fix
                ctx.setTransform(1, 0, 0, 1, 0, 0);
                const afterReset = ctx.getTransform();
                logMessage(`After setTransform(1,0,0,1,0,0): [${afterReset.a}, ${afterReset.b}, ${afterReset.c}, ${afterReset.d}, ${afterReset.e}, ${afterReset.f}]`, 'info');

            } catch (error) {
                logMessage(`‚ùå Error creating test canvas: ${error.message}`, 'error');
            }
        }

        function inspectDOM() {
            logMessage('Inspecting main application DOM...');

            // Check if we can access the main app
            const mainApp = window.open('', 'mainApp');

            if (mainApp && !mainApp.closed) {
                try {
                    const allElements = mainApp.document.querySelectorAll('*');
                    const canvasElements = mainApp.document.querySelectorAll('canvas');
                    const displayElements = mainApp.document.querySelectorAll('[class*="display"], [class*="container"], [class*="floating"]');

                    logMessage(`Main app has ${allElements.length} total elements`, 'info');
                    logMessage(`Found ${canvasElements.length} canvas elements`, 'info');
                    logMessage(`Found ${displayElements.length} display-related elements`, 'info');

                    // Check for hidden canvases
                    canvasElements.forEach((canvas, i) => {
                        const style = mainApp.getComputedStyle(canvas);
                        const rect = canvas.getBoundingClientRect();

                        logMessage(`Canvas ${i+1}:`, 'info');
                        logMessage(`  - Dimensions: ${canvas.width}x${canvas.height}`, 'info');
                        logMessage(`  - Position: (${Math.round(rect.left)}, ${Math.round(rect.top)})`, 'info');
                        logMessage(`  - Size: ${Math.round(rect.width)}x${Math.round(rect.height)}`, 'info');
                        logMessage(`  - Display: ${style.display}`, 'info');
                        logMessage(`  - Visibility: ${style.visibility}`, 'info');
                        logMessage(`  - Opacity: ${style.opacity}`, 'info');
                        logMessage(`  - Z-index: ${style.zIndex}`, 'info');
                        logMessage(`  - Has content: ${checkCanvasContent(canvas)}`, 'info');
                    });

                } catch (error) {
                    logMessage(`‚ùå Error inspecting DOM: ${error.message}`, 'error');
                }
            } else {
                logMessage('‚ùå Main application window not accessible', 'error');
                logMessage('Use "Test Window Access" first to open the main app', 'info');
            }
        }

        function checkCanvasContent(canvas) {
            try {
                const ctx = canvas.getContext('2d');
                if (!ctx) return false;

                const imageData = ctx.getImageData(0, 0, Math.min(canvas.width, 100), Math.min(canvas.height, 100));
                const pixels = imageData.data;

                // Check if any non-transparent pixels exist
                for (let i = 3; i < pixels.length; i += 4) {
                    if (pixels[i] > 0) return true;
                }
                return false;
            } catch (error) {
                return false;
            }
        }

        function clearLog() {
            log.innerHTML = '';
        }

        // Initialize
        logMessage('Canvas Debug Test loaded successfully', 'success');
        status.textContent = 'Ready for testing';

        // Auto-test application availability
        fetch('http://localhost:5174')
            .then(response => {
                if (response.ok) {
                    logMessage('‚úÖ Main application is accessible', 'success');
                    status.textContent = 'Connected to localhost:5174';
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            })
            .catch(error => {
                logMessage(`‚ùå Cannot access main application: ${error.message}`, 'error');
                status.textContent = 'Connection failed';
            });
    </script>
</body>
</html>
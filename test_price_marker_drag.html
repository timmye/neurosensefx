<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Price Marker Drag Detection Test</title>
    <style>
        body {
            font-family: 'JetBrains Mono', monospace;
            background: #111827;
            color: #f9fafb;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .test-canvas {
            background: #1f2937;
            border: 2px solid #374151;
            border-radius: 8px;
            cursor: pointer;
            margin: 20px 0;
        }
        .instructions {
            background: #1f2937;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .log {
            background: #000;
            color: #10b981;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
            margin: 20px 0;
        }
        .highlight {
            color: #fbbf24;
        }
    </style>
</head>
<body>
    <h1>Price Marker Drag Detection Test</h1>

    <div class="instructions">
        <h3>Test Instructions:</h3>
        <ul>
            <li><span class="highlight">Marker Placement:</span> Ctrl/Cmd + Click on canvas â†’ should create/remove markers</li>
            <li><span class="highlight">Drag Test:</span> Click, drag > 5px, release â†’ should NOT create a marker (even with Ctrl/Cmd)</li>
            <li><span class="highlight">Regular Click:</span> Click without modifier â†’ should NOT create a marker (allows display dragging)</li>
            <li><span class="highlight">Click Existing Marker:</span> Ctrl/Cmd + Click near a marker â†’ should remove it</li>
        </ul>
        <p><strong>Why modifier key?</strong> Prevents conflict between display dragging and marker placement.</p>
    </div>

    <canvas id="testCanvas" class="test-canvas" width="400" height="300"></canvas>

    <div class="log" id="log">Test log will appear here...</div>

    <script>
        // Simulate the drag detection logic from Container.svelte
        let isDragging = false;
        let dragStartPos = null;
        let dragThreshold = 5; // pixels
        let markers = [];

        const canvas = document.getElementById('testCanvas');
        const ctx = canvas.getContext('2d');
        const log = document.getElementById('log');

        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            log.textContent += `[${timestamp}] ${message}\n`;
            log.scrollTop = log.scrollHeight;
        }

        function drawCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw background
            ctx.fillStyle = '#1f2937';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw markers
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 2;
            markers.forEach(marker => {
                ctx.beginPath();
                ctx.moveTo(0, marker.y);
                ctx.lineTo(canvas.width, marker.y);
                ctx.stroke();

                // Draw marker label
                ctx.fillStyle = '#fff';
                ctx.font = '12px monospace';
                ctx.fillText(`Marker at ${marker.y}`, 10, marker.y - 5);
            });

            // Draw drag state indicator
            ctx.fillStyle = isDragging ? '#ef4444' : '#10b981';
            ctx.font = '14px monospace';
            ctx.fillText(`State: ${isDragging ? 'DRAGGING' : 'CLICKING'}`, 10, 20);
        }

        function handleMouseDown(event) {
            const rect = canvas.getBoundingClientRect();
            dragStartPos = {
                x: event.clientX - rect.left,
                y: event.clientY - rect.top
            };
            isDragging = false;
            addLog(`ğŸŸ¢ Mouse down at (${dragStartPos.x.toFixed(1)}, ${dragStartPos.y.toFixed(1)})`);
            drawCanvas();
        }

        function handleMouseMove(event) {
            if (!dragStartPos) return;

            const rect = canvas.getBoundingClientRect();
            const currentX = event.clientX - rect.left;
            const currentY = event.clientY - rect.top;
            const distance = Math.sqrt(
                Math.pow(currentX - dragStartPos.x, 2) +
                Math.pow(currentY - dragStartPos.y, 2)
            );

            if (distance > dragThreshold) {
                isDragging = true;
                addLog(`ğŸ”„ Drag detected! Distance: ${distance.toFixed(1)}px`);
                drawCanvas();
            }
        }

        function handleMouseUp(event) {
            if (!dragStartPos) return;

            // Require modifier key (Ctrl/Cmd) for marker placement
            const hasModifier = event.ctrlKey || event.metaKey;

            if (isDragging) {
                addLog(`âŒ DRAG END - No marker created`);
            } else if (!hasModifier) {
                addLog(`âš ï¸ No modifier key - No marker created (use Ctrl/Cmd + Click)`);
            } else {
                const rect = canvas.getBoundingClientRect();
                const y = event.clientY - rect.top;

                // Check if clicking on existing marker
                const existingMarker = markers.find(marker =>
                    Math.abs(marker.y - y) < 5
                );

                if (existingMarker) {
                    markers = markers.filter(m => m !== existingMarker);
                    addLog(`ğŸ—‘ï¸ Removed marker at y=${existingMarker.y.toFixed(1)}`);
                } else {
                    markers.push({ y, id: Date.now() });
                    addLog(`â• Added marker at y=${y.toFixed(1)}`);
                }
            }

            // Reset state
            dragStartPos = null;
            isDragging = false;
            drawCanvas();
        }

        function handleMouseLeave() {
            if (dragStartPos) {
                addLog(`ğŸ‘‹ Mouse left canvas - resetting drag state`);
                dragStartPos = null;
                isDragging = false;
                drawCanvas();
            }
        }

        // Add event listeners
        canvas.addEventListener('mousedown', handleMouseDown);
        canvas.addEventListener('mousemove', handleMouseMove);
        canvas.addEventListener('mouseup', handleMouseUp);
        canvas.addEventListener('mouseleave', handleMouseLeave);

        // Initial draw
        addLog('ğŸš€ Test canvas ready - Start testing!');
        drawCanvas();
    </script>
</body>
</html>
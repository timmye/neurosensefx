# Enhanced Development Docker Compose Configuration
# Optimized for hot reload and developer experience

version: '3.8'

services:
  # Development Frontend with Hot Reload
  frontend-dev:
    build:
      context: .
      dockerfile: Dockerfile.frontend
      target: development
    container_name: neurosensefx-frontend-dev
    restart: unless-stopped
    environment:
      - NODE_ENV=development
      - VITE_DEV=true
      - VITE_BACKEND_URL=ws://localhost:8080
      - CHOKIDAR_USEPOLLING=true
      - CHOKIDAR_INTERVAL=1000
    ports:
      - "5173:5173"
      - "5174:5174"  # Alternative port for testing
    volumes:
      # Mount source code for hot reload
      - ./src:/app/src
      - ./public:/app/public
      - ./package.json:/app/package.json
      - ./package-lock.json:/app/package-lock.json
      - ./vite.config.js:/app/vite.config.js
      - ./vitest.config.js:/app/vitest.config.js
      # Node modules for faster startup (cached)
      - node_modules_dev:/app/node_modules
    depends_on:
      - backend-dev
    networks:
      - neurosensefx-dev-network
    command: npm run dev
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5173"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Development Backend with Debug Support
  backend-dev:
    build:
      context: ./services/tick-backend
      dockerfile: Dockerfile.dev
    container_name: neurosensefx-backend-dev
    restart: unless-stopped
    environment:
      - NODE_ENV=development
      - WS_PORT=8080
      - DEBUG=neurosensefx:*
      - CTRADER_CLIENT_ID=${CTRADER_CLIENT_ID}
      - CTRADER_CLIENT_SECRET=${CTRADER_CLIENT_SECRET}
      - CTRADER_ACCESS_TOKEN=${CTRADER_ACCESS_TOKEN}
      - CTRADER_REFRESH_TOKEN=${CTRADER_REFRESH_TOKEN}
      - CTRADER_ACCOUNT_ID=${CTRADER_ACCOUNT_ID}
    ports:
      - "8080:8080"
      - "9229:9229"  # Node.js debugger port
      - "9230:9230"  # Alternative debugger port
    volumes:
      # Mount source code for hot reload
      - ./services/tick-backend:/app
      - ./libs/cTrader-Layer:/app/libs/cTrader-Layer
      # Logs for debugging
      - dev-logs:/app/logs
    networks:
      - neurosensefx-dev-network
    command: npm run dev
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Redis for development
  redis-dev:
    image: redis:7-alpine
    container_name: neurosensefx-redis-dev
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    ports:
      - "6379:6379"
    volumes:
      - redis-dev-data:/data
    networks:
      - neurosensefx-dev-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 15s
      timeout: 5s
      retries: 3

  # Development Database (optional)
  postgres-dev:
    image: postgres:15-alpine
    container_name: neurosensefx-postgres-dev
    restart: unless-stopped
    environment:
      - POSTGRES_DB=neurosensefx_dev
      - POSTGRES_USER=neurosensefx
      - POSTGRES_PASSWORD=neurosensefx_dev_123
    ports:
      - "5432:5432"
    volumes:
      - postgres-dev-data:/var/lib/postgresql/data
      - ./docker/postgres/init:/docker-entrypoint-initdb.d
    networks:
      - neurosensefx-dev-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U neurosensefx"]
      interval: 15s
      timeout: 5s
      retries: 3

  # MailHog for email testing
  mailhog:
    image: mailhog/mailhog:latest
    container_name: neurosensefx-mailhog
    restart: unless-stopped
    ports:
      - "1025:1025"  # SMTP port
      - "8025:8025"  # Web interface
    networks:
      - neurosensefx-dev-network

  # Development tools
  adminer:
    image: adminer:latest
    container_name: neurosensefx-adminer
    restart: unless-stopped
    ports:
      - "8082:8080"
    environment:
      - ADMINER_DEFAULT_SERVER=postgres-dev
    depends_on:
      - postgres-dev
    networks:
      - neurosensefx-dev-network

networks:
  neurosensefx-dev-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/16

volumes:
  node_modules_dev:
    driver: local
  redis-dev-data:
    driver: local
  postgres-dev-data:
    driver: local
  dev-logs:
    driver: local

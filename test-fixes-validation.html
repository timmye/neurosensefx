<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Fixes Validation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #333;
            border-radius: 5px;
        }
        .success { border-color: #10b981; background: rgba(16, 185, 129, 0.1); }
        .error { border-color: #ef4444; background: rgba(239, 68, 68, 0.1); }
        .warning { border-color: #f59e0b; background: rgba(245, 158, 11, 0.1); }
        canvas {
            border: 1px solid #555;
            margin: 10px 0;
        }
        pre {
            background: #000;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>üîß Debug Fixes Validation Test</h1>
    
    <div class="test-section">
        <h2>üß™ Test 1: workspaceGrid.js Import Fix</h2>
        <p>Testing ES6 import instead of require() for browser compatibility...</p>
        <div id="gridTest">Loading...</div>
    </div>
    
    <div class="test-section">
        <h2>üß™ Test 2: marketProfile.js fontSize Fix</h2>
        <p>Testing configureTextForDPR integration and fontSize variable fix...</p>
        <canvas id="marketProfileCanvas" width="300" height="200"></canvas>
        <div id="marketProfileTest">Loading...</div>
    </div>
    
    <div class="test-section">
        <h2>üß™ Test 3: Fuzzy Display Fixes Validation</h2>
        <p>Testing pixel-perfect canvas rendering with DPR awareness...</p>
        <canvas id="crispCanvas" width="244.51" height="156.08"></canvas>
        <div id="crispTest">Loading...</div>
    </div>

    <script type="module">
        // Test 1: workspaceGrid.js Import Fix
        async function testWorkspaceGrid() {
            const testDiv = document.getElementById('gridTest');
            try {
                // Test dynamic import (simulating browser environment)
                const workspaceGridModule = await import('./src/utils/workspaceGrid.js');
                const { workspaceGrid } = workspaceGridModule;
                
                if (workspaceGrid && typeof workspaceGrid.loadSettings === 'function') {
                    testDiv.className = 'test-section success';
                    testDiv.innerHTML = `
                        <h3>‚úÖ PASSED</h3>
                        <p>workspaceGrid.js loads successfully with ES6 imports</p>
                        <pre>‚úì WorkspaceGrid class exported
‚úì loadSettings function available
‚úì saveSettings function available
‚úì No require() errors detected</pre>
                    `;
                } else {
                    throw new Error('WorkspaceGrid not properly exported');
                }
            } catch (error) {
                testDiv.className = 'test-section error';
                testDiv.innerHTML = `
                    <h3>‚ùå FAILED</h3>
                    <p>workspaceGrid.js import failed</p>
                    <pre>Error: ${error.message}</pre>
                `;
            }
        }

        // Test 2: marketProfile.js fontSize Fix
        async function testMarketProfile() {
            const testDiv = document.getElementById('marketProfileTest');
            const canvas = document.getElementById('marketProfileCanvas');
            const ctx = canvas.getContext('2d');
            
            try {
                // Import canvasSizing for configureTextForDPR
                const canvasSizingModule = await import('./src/utils/canvasSizing.js');
                const { configureTextForDPR } = canvasSizingModule;
                
                // Test configureTextForDPR function
                const canvasDimensions = {
                    dpr: window.devicePixelRatio || 1,
                    canvas: { width: 300, height: 200 }
                };
                
                const textConfig = configureTextForDPR(ctx, canvasDimensions, {
                    baseFontSize: 10,
                    fontFamily: 'Arial',
                    textAlign: 'center',
                    textBaseline: 'middle',
                    fillStyle: '#FFFFFF'
                });
                
                // Test the specific scenario that was failing
                const testText = '1000';
                ctx.font = textConfig.fontString;
                ctx.fillStyle = textConfig.fillStyle;
                ctx.textAlign = textConfig.textAlign;
                ctx.textBaseline = textConfig.textBaseline;
                
                const textMetrics = ctx.measureText(testText);
                
                // Test background positioning with textConfig.baseFontSize
                const padding = 4;
                const bgX = 150 - textMetrics.width / 2 - padding;
                const bgY = 100 - textConfig.baseFontSize / 2 - padding; // This was the failing line
                const bgWidth = textMetrics.width + (padding * 2);
                const bgHeight = textConfig.baseFontSize + (padding * 2);
                
                // Draw test
                ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                ctx.fillRect(bgX, bgY, bgWidth, bgHeight);
                ctx.fillStyle = '#FFFFFF';
                ctx.fillText(testText, 150, 100);
                
                testDiv.className = 'test-section success';
                testDiv.innerHTML = `
                    <h3>‚úÖ PASSED</h3>
                    <p>marketProfile.js fontSize fix working correctly</p>
                    <pre>‚úì configureTextForDPR function available
‚úì textConfig.baseFontSize: ${textConfig.baseFontSize}
‚úì Background positioning calculated correctly
‚úì No fontSize undefined errors
‚úì Canvas rendering successful</pre>
                `;
            } catch (error) {
                testDiv.className = 'test-section error';
                testDiv.innerHTML = `
                    <h3>‚ùå FAILED</h3>
                    <p>marketProfile.js fontSize test failed</p>
                    <pre>Error: ${error.message}</pre>
                `;
            }
        }

        // Test 3: Fuzzy Display Fixes Validation
        async function testCrispRendering() {
            const testDiv = document.getElementById('crispTest');
            const canvas = document.getElementById('crispCanvas');
            const ctx = canvas.getContext('2d');
            
            try {
                // Import canvasSizing utilities
                const canvasSizingModule = await import('./src/utils/canvasSizing.js');
                const { getCanvasDimensions, configureTextForDPR } = canvasSizingModule;
                
                // Test fractional canvas dimensions (the original problem)
                const containerSize = { width: 244.51, height: 156.08 };
                const canvasDimensions = getCanvasDimensions(containerSize);
                
                // Set canvas with pixel-perfect dimensions
                canvas.width = canvasDimensions.canvas.width;
                canvas.height = canvasDimensions.canvas.height;
                canvas.style.width = canvasDimensions.canvas.cssWidth + 'px';
                canvas.style.height = canvasDimensions.canvas.cssHeight + 'px';
                
                // Configure for crisp rendering
                ctx.save();
                ctx.translate(0.5, 0.5);
                ctx.imageSmoothingEnabled = false;
                
                // Test text rendering with DPR awareness
                const textConfig = configureTextForDPR(ctx, canvasDimensions, {
                    baseFontSize: 10,
                    fontFamily: 'Arial',
                    textAlign: 'center',
                    textBaseline: 'middle',
                    fillStyle: '#FFFFFF'
                });
                
                // Draw test elements
                ctx.fillStyle = '#10b981';
                ctx.fillRect(10, 10, 50, 30);
                
                ctx.font = textConfig.fontString;
                ctx.fillStyle = textConfig.fillStyle;
                ctx.fillText('CRISP', canvasDimensions.canvas.cssWidth / 2, canvasDimensions.canvas.cssHeight / 2);
                
                ctx.restore();
                
                testDiv.className = 'test-section success';
                testDiv.innerHTML = `
                    <h3>‚úÖ PASSED</h3>
                    <p>Fuzzy display fixes working correctly</p>
                    <pre>‚úì Integer canvas dimensions: ${canvas.width}√ó${canvas.height}
‚úì CSS dimensions: ${canvasDimensions.canvas.cssWidth}√ó${canvasDimensions.canvas.cssHeight}
‚úì DPR: ${canvasDimensions.dpr}
‚úì Text rendering configured: ${textConfig.finalFontSize}px
‚úì Pixel-perfect rendering active</pre>
                `;
            } catch (error) {
                testDiv.className = 'test-section error';
                testDiv.innerHTML = `
                    <h3>‚ùå FAILED</h3>
                    <p>Fuzzy display fixes test failed</p>
                    <pre>Error: ${error.message}</pre>
                `;
            }
        }

        // Run all tests
        async function runAllTests() {
            console.log('üß™ Starting debug fixes validation tests...');
            
            await testWorkspaceGrid();
            await testMarketProfile();
            await testCrispRendering();
            
            console.log('‚úÖ All tests completed!');
        }

        // Initialize tests when page loads
        runAllTests();
    </script>
</body>
</html>

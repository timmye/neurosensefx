<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canvas Visibility Test</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #1a1a1a;
            color: white;
            font-family: monospace;
        }
        .test-container {
            border: 2px solid #333;
            margin: 10px 0;
            padding: 10px;
        }
        canvas {
            border: 1px solid #666;
            background: #111827;
        }
        .diagnostics {
            background: #222;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .error {
            color: #ff6b6b;
        }
        .success {
            color: #51cf66;
        }
        .warning {
            color: #ffd43b;
        }
    </style>
</head>
<body>
    <h1>Canvas Visibility Diagnostics</h1>

    <div class="test-container">
        <h2>1. Basic Canvas Test</h2>
        <canvas id="basic-canvas" width="220" height="120"></canvas>
        <div id="basic-result" class="diagnostics"></div>
    </div>

    <div class="test-container">
        <h2>2. DPR-Aware Canvas Test</h2>
        <canvas id="dpr-canvas" width="220" height="120"></canvas>
        <div id="dpr-result" class="diagnostics"></div>
    </div>

    <div class="test-container">
        <h2>3. Application Health Check</h2>
        <div id="app-health" class="diagnostics"></div>
    </div>

    <script>
        // Test 1: Basic Canvas Functionality
        function testBasicCanvas() {
            const canvas = document.getElementById('basic-canvas');
            const result = document.getElementById('basic-result');
            const ctx = canvas.getContext('2d');

            try {
                if (!ctx) {
                    throw new Error('Failed to get 2D context');
                }

                // Draw something
                ctx.fillStyle = '#111827';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                ctx.fillStyle = '#4f46e5';
                ctx.fillRect(10, 10, 50, 30);

                ctx.fillStyle = '#ffffff';
                ctx.font = '12px monospace';
                ctx.fillText('Basic Canvas Test', 10, 60);

                result.innerHTML = '<span class="success">✓ Basic canvas rendering works</span>';
                return true;
            } catch (error) {
                result.innerHTML = `<span class="error">✗ Basic canvas failed: ${error.message}</span>`;
                return false;
            }
        }

        // Test 2: DPR-Aware Canvas
        function testDPRCanvas() {
            const canvas = document.getElementById('dpr-canvas');
            const result = document.getElementById('dpr-result');
            const ctx = canvas.getContext('2d');

            try {
                const dpr = window.devicePixelRatio || 1;

                // Set actual size in memory
                canvas.width = 220 * dpr;
                canvas.height = 120 * dpr;

                // Set display size
                canvas.style.width = '220px';
                canvas.style.height = '120px';

                // Scale context for DPR
                ctx.scale(dpr, dpr);

                // Draw something
                ctx.fillStyle = '#111827';
                ctx.fillRect(0, 0, 220, 120);

                ctx.fillStyle = '#22c55e';
                ctx.fillRect(10, 10, 50, 30);

                ctx.fillStyle = '#ffffff';
                ctx.font = '12px monospace';
                ctx.fillText(`DPR Canvas (DPR: ${dpr})`, 10, 60);

                result.innerHTML = `<span class="success">✓ DPR canvas works (DPR: ${dpr})</span>`;
                return true;
            } catch (error) {
                result.innerHTML = `<span class="error">✗ DPR canvas failed: ${error.message}</span>`;
                return false;
            }
        }

        // Test 3: Check if the main application is accessible
        async function checkAppHealth() {
            const result = document.getElementById('app-health');

            try {
                // Check if we can fetch the app
                const response = await fetch('http://localhost:5174');
                const html = await response.text();

                const diagnostics = {
                    appStatus: response.ok ? 'accessible' : 'not accessible',
                    statusCode: response.status,
                    hasAppDiv: html.includes('id="app"'),
                    hasMainScript: html.includes('src/main.js'),
                    hasViteClient: html.includes('@vite/client')
                };

                result.innerHTML = `
                    <div><span class="success">✓ Application Status:</span> ${diagnostics.appStatus} (${diagnostics.statusCode})</div>
                    <div><span class="success">✓ Has App Div:</span> ${diagnostics.hasAppDiv}</div>
                    <div><span class="success">✓ Has Main Script:</span> ${diagnostics.hasMainScript}</div>
                    <div><span class="success">✓ Has Vite Client:</span> ${diagnostics.hasViteClient}</div>
                `;

                return diagnostics;
            } catch (error) {
                result.innerHTML = `<span class="error">✗ App health check failed: ${error.message}</span>`;
                return null;
            }
        }

        // Run all tests
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('Starting canvas visibility diagnostics...');

            const basicWorks = testBasicCanvas();
            const dprWorks = testDPRCanvas();
            const appHealth = await checkAppHealth();

            console.log('Diagnostics complete:', {
                basicCanvas: basicWorks,
                dprCanvas: dprWorks,
                appHealth: appHealth
            });

            // Additional browser diagnostics
            const browserInfo = {
                userAgent: navigator.userAgent,
                dpr: window.devicePixelRatio || 1,
                screenWidth: screen.width,
                screenHeight: screen.height,
                canvasSupport: !!document.createElement('canvas').getContext
            };

            console.log('Browser Info:', browserInfo);
        });
    </script>
</body>
</html>
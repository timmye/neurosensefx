<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browser Console Test - NeuroSense FX</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #1a1a1a;
            color: white;
            font-family: monospace;
        }
        .test-section {
            border: 1px solid #333;
            margin: 10px 0;
            padding: 15px;
            border-radius: 4px;
        }
        .console-output {
            background: #000;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .success { color: #51cf66; }
        .error { color: #ff6b6b; }
        .warning { color: #ffd43b; }
        .info { color: #74c0fc; }
        button {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #3730a3; }
        button:disabled { background: #6b7280; cursor: not-allowed; }
        iframe {
            width: 100%;
            height: 400px;
            border: 1px solid #333;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>NeuroSense FX Browser Console Test</h1>

    <div class="test-section">
        <h2>Application Load Test</h2>
        <button onclick="testAppLoad()">Test App Load</button>
        <button onclick="testCreateDisplay()">Create Test Display</button>
        <button onclick="testCanvasCheck()">Check Canvas Elements</button>
        <button onclick="clearConsole()">Clear Console</button>
        <div id="console-output" class="console-output">Console output will appear here...</div>
    </div>

    <div class="test-section">
        <h2>Application Preview</h2>
        <iframe id="app-frame" src="http://localhost:5174/"></iframe>
    </div>

    <script>
        // Enhanced console logging
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;

        function addToConsole(type, ...args) {
            const output = document.getElementById('console-output');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = `[${timestamp}] ${type.toUpperCase()}:`;

            let message = prefix + ' ' + args.map(arg =>
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');

            output.innerHTML += message + '\n';
            output.scrollTop = output.scrollHeight;

            // Also log to real console
            const originalConsole = type === 'error' ? originalError :
                                  type === 'warn' ? originalWarn : originalLog;
            originalConsole.apply(console, args);
        }

        console.log = (...args) => addToConsole('info', ...args);
        console.warn = (...args) => addToConsole('warning', ...args);
        console.error = (...args) => addToConsole('error', ...args);

        function clearConsole() {
            document.getElementById('console-output').innerHTML = 'Console cleared...\n';
        }

        async function testAppLoad() {
            console.log('Testing application load...');

            try {
                const iframe = document.getElementById('app-frame');
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;

                // Wait for iframe to load
                iframe.onload = () => {
                    console.log('Iframe loaded successfully');

                    // Check if app div exists
                    const appDiv = iframeDoc.getElementById('app');
                    if (appDiv) {
                        console.log('✓ App div found');

                        // Check if displayActions is available
                        setTimeout(() => {
                            try {
                                const displayActions = iframe.contentWindow.displayActions;
                                if (displayActions) {
                                    console.log('✓ displayActions available');
                                    console.log('displayActions methods:', Object.getOwnPropertyNames(displayActions));
                                } else {
                                    console.error('✗ displayActions not available');
                                }
                            } catch (e) {
                                console.error('✗ Error accessing displayActions:', e.message);
                            }
                        }, 2000);

                    } else {
                        console.error('✗ App div not found');
                    }
                };

                // Reload iframe
                iframe.src = iframe.src;

            } catch (error) {
                console.error('Error testing app load:', error);
            }
        }

        async function testCreateDisplay() {
            console.log('Testing display creation...');

            try {
                const iframe = document.getElementById('app-frame');
                const iframeWindow = iframe.contentWindow;

                if (!iframeWindow.displayActions) {
                    console.error('✗ displayActions not available');
                    return;
                }

                // Create a display
                const displayId = iframeWindow.displayActions.addDisplay('EURUSD', { x: 150, y: 150 });
                console.log('✓ Display created with ID:', displayId);

                // Wait for canvas to appear
                setTimeout(() => {
                    const canvases = iframeWindow.document.querySelectorAll('canvas');
                    console.log(`Found ${canvases.length} canvas elements`);

                    canvases.forEach((canvas, index) => {
                        const rect = canvas.getBoundingClientRect();
                        console.log(`Canvas ${index}:`, {
                            width: canvas.width,
                            height: canvas.height,
                            clientWidth: canvas.clientWidth,
                            clientHeight: canvas.clientHeight,
                            visible: rect.width > 0 && rect.height > 0,
                            position: { left: rect.left, top: rect.top }
                        });
                    });
                }, 1000);

            } catch (error) {
                console.error('Error creating display:', error);
            }
        }

        async function testCanvasCheck() {
            console.log('Checking canvas elements...');

            try {
                const iframe = document.getElementById('app-frame');
                const iframeWindow = iframe.contentWindow;

                const canvases = iframeWindow.document.querySelectorAll('canvas');
                console.log(`Total canvas elements found: ${canvases.length}`);

                if (canvases.length === 0) {
                    console.warn('No canvas elements found - checking for floating displays...');

                    const floatingDisplays = iframeWindow.document.querySelectorAll('.enhanced-floating');
                    console.log(`Found ${floatingDisplays.length} floating display containers`);

                    const loadingDivs = iframeWindow.document.querySelectorAll('.loading');
                    console.log(`Found ${loadingDivs.length} loading divs`);

                } else {
                    canvases.forEach((canvas, index) => {
                        const ctx = canvas.getContext('2d');
                        const rect = canvas.getBoundingClientRect();

                        console.log(`Canvas ${index} details:`, {
                            hasContext: !!ctx,
                            dimensions: {
                                width: canvas.width,
                                height: canvas.height,
                                clientWidth: canvas.clientWidth,
                                clientHeight: canvas.clientHeight
                            },
                            position: rect,
                            visible: rect.width > 0 && rect.height > 0,
                            dpr: iframeWindow.devicePixelRatio || 1
                        });

                        // Check if canvas has content
                        if (ctx) {
                            try {
                                const imageData = ctx.getImageData(0, 0, Math.min(canvas.width, 50), Math.min(canvas.height, 50));
                                const hasContent = imageData.data.some((channel, idx) => {
                                    return idx % 4 !== 3 && channel !== 0 && channel !== 17; // Not transparent or default background
                                });
                                console.log(`Canvas ${index} has content:`, hasContent);
                            } catch (e) {
                                console.warn(`Could not read canvas ${index} content:`, e.message);
                            }
                        }
                    });
                }

            } catch (error) {
                console.error('Error checking canvas:', error);
            }
        }

        // Auto-run initial test
        window.addEventListener('load', () => {
            setTimeout(() => {
                testAppLoad();
            }, 1000);
        });
    </script>
</body>
</html>
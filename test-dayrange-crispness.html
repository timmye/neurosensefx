<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Day Range Meter Crispness Test</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: #ffffff;
        }
        
        .test-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .test-section {
            border: 1px solid #444;
            padding: 15px;
            background: #2a2a2a;
            border-radius: 8px;
        }
        
        .test-section h3 {
            margin-top: 0;
            color: #4ade80;
        }
        
        .canvas-container {
            margin: 10px 0;
            position: relative;
        }
        
        canvas {
            border: 1px solid #666;
            background: #111827;
        }
        
        .controls {
            margin: 20px 0;
            padding: 15px;
            background: #333;
            border-radius: 8px;
        }
        
        .control-group {
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .control-group label {
            min-width: 120px;
        }
        
        .control-group input {
            padding: 5px;
            background: #444;
            border: 1px solid #666;
            color: white;
            border-radius: 4px;
        }
        
        .control-group button {
            padding: 8px 15px;
            background: #4ade80;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .control-group button:hover {
            background: #22c55e;
        }
        
        .debug-info {
            background: #1f2937;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            margin: 10px 0;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .zoom-controls {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }
        
        .zoom-btn {
            padding: 5px 10px;
            background: #374151;
            color: white;
            border: 1px solid #4b5563;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .zoom-btn:hover {
            background: #4b5563;
        }
        
        .zoom-btn.active {
            background: #4ade80;
            border-color: #22c55e;
        }
    </style>
</head>
<body>
    <h1>Day Range Meter Crispness Test</h1>
    
    <div class="controls">
        <div class="control-group">
            <label>Display Type:</label>
            <select id="displayType">
                <option value="audusd">AUDUSD-like (244.51Ã—156.08)</option>
                <option value="eurusd">EURUSD-like (220Ã—160)</option>
                <option value="custom">Custom</option>
            </select>
        </div>
        
        <div class="control-group" id="customControls" style="display: none;">
            <label>Width:</label>
            <input type="number" id="customWidth" value="220" step="0.01">
            <label>Height:</label>
            <input type="number" id="customHeight" value="160" step="0.01">
        </div>
        
        <div class="control-group">
            <label>DPR:</label>
            <span id="dprDisplay">1</span>
        </div>
        
        <div class="control-group">
            <label>Browser Zoom:</label>
            <select id="browserZoomMode">
                <option value="actual">Actual Browser Zoom</option>
                <option value="simulated">Simulated Zoom Levels</option>
            </select>
        </div>
        
        <div class="control-group">
            <label>Zoom Level:</label>
            <span id="zoomDisplay">100%</span>
        </div>
        
        <div class="zoom-controls" id="zoomControls">
            <button class="zoom-btn" data-zoom="0.25">25%</button>
            <button class="zoom-btn" data-zoom="0.5">50%</button>
            <button class="zoom-btn" data-zoom="0.75">75%</button>
            <button class="zoom-btn" data-zoom="0.9">90%</button>
            <button class="zoom-btn active" data-zoom="1">100%</button>
            <button class="zoom-btn" data-zoom="1.25">125%</button>
            <button class="zoom-btn" data-zoom="1.5">150%</button>
        </div>
        
        <div class="control-group">
            <button id="runTest">Run Test</button>
            <button id="clearDebug">Clear Debug</button>
        </div>
    </div>
    
    <div class="test-container">
        <div class="test-section">
            <h3>Current Rendering (dayRangeMeter.js)</h3>
            <div class="canvas-container">
                <canvas id="currentCanvas"></canvas>
            </div>
        </div>
        
        <div class="test-section">
            <h3>Crisp Rendering (Proposed Fix)</h3>
            <div class="canvas-container">
                <canvas id="crispCanvas"></canvas>
            </div>
        </div>
    </div>
    
    <div class="debug-info" id="debugInfo">
Waiting for test data...
    </div>

    <script>
        class DayRangeCrispnessTest {
            constructor() {
                this.currentCanvas = document.getElementById('currentCanvas');
                this.crispCanvas = document.getElementById('crispCanvas');
                this.debugInfo = document.getElementById('debugInfo');
                this.currentCtx = this.currentCanvas.getContext('2d');
                this.crispCtx = this.crispCanvas.getContext('2d');
                
                this.displayType = 'audusd';
                this.browserZoom = 1;
                
                this.initializeEventListeners();
                this.updateEnvironmentInfo();
                this.runTest();
            }
            
            initializeEventListeners() {
                document.getElementById('displayType').addEventListener('change', (e) => {
                    this.displayType = e.target.value;
                    this.updateCustomControls();
                    this.runTest();
                });
                
                document.getElementById('customWidth').addEventListener('input', () => this.runTest());
                document.getElementById('customHeight').addEventListener('input', () => this.runTest());
                document.getElementById('runTest').addEventListener('click', () => this.runTest());
                document.getElementById('clearDebug').addEventListener('click', () => this.clearDebug());
                
                // Zoom control buttons
                document.querySelectorAll('.zoom-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.zoom-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        this.setBrowserZoom(parseFloat(e.target.dataset.zoom));
                    });
                });
                
                // Monitor browser zoom changes
                window.addEventListener('resize', () => {
                    this.updateEnvironmentInfo();
                    this.runTest();
                });
            }
            
            updateCustomControls() {
                const customControls = document.getElementById('customControls');
                customControls.style.display = this.displayType === 'custom' ? 'flex' : 'none';
            }
            
            updateEnvironmentInfo() {
                const dpr = window.devicePixelRatio || 1;
                const browserZoomMode = document.getElementById('browserZoomMode').value;
                const browserZoom = browserZoomMode === 'actual' ? this.getBrowserZoom() : this.browserZoom;
                const effectiveDpr = dpr * browserZoom;
                
                document.getElementById('dprDisplay').textContent = dpr.toFixed(3);
                document.getElementById('zoomDisplay').textContent = (browserZoom * 100).toFixed(0) + '%';
                document.getElementById('effectiveDprDisplay').textContent = effectiveDpr.toFixed(3);
            }
            
            getBrowserZoom() {
                // Primary method: use actual browser zoom level
                if (window.visualViewport && window.visualViewport.scale) {
                    return window.visualViewport.scale;
                }
                
                // Fallback 1: use devicePixelRatio for high-DPI displays
                if (window.devicePixelRatio && window.devicePixelRatio !== 1) {
                    return window.devicePixelRatio;
                }
                
                // Fallback 2: assume standard zoom (most common case)
                return 1.0;
            }
            
            setBrowserZoom(zoomLevel) {
                this.browserZoom = zoomLevel;
                // This simulates different browser zoom levels for testing
                this.updateEnvironmentInfo();
                this.runTest();
            }
            
            initializeEventListeners() {
                document.getElementById('displayType').addEventListener('change', (e) => {
                    this.displayType = e.target.value;
                    this.updateCustomControls();
                    this.runTest();
                });
                
                document.getElementById('customWidth').addEventListener('input', () => this.runTest());
                document.getElementById('customHeight').addEventListener('input', () => this.runTest());
                document.getElementById('runTest').addEventListener('click', () => this.runTest());
                document.getElementById('clearDebug').addEventListener('click', () => this.clearDebug());
                
                // Browser zoom mode selector
                document.getElementById('browserZoomMode').addEventListener('change', () => {
                    this.updateEnvironmentInfo();
                    this.runTest();
                });
                
                // Zoom control buttons
                document.querySelectorAll('.zoom-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.zoom-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        this.setBrowserZoom(parseFloat(e.target.dataset.zoom));
                    });
                });
                
                // Monitor browser zoom changes
                window.addEventListener('resize', () => {
                    this.updateEnvironmentInfo();
                    this.runTest();
                });
            }
            
            getDisplayDimensions() {
                switch (this.displayType) {
                    case 'audusd':
                        return { width: 244.51, height: 156.08 };
                    case 'eurusd':
                        return { width: 220, height: 160 };
                    case 'custom':
                        return {
                            width: parseFloat(document.getElementById('customWidth').value),
                            height: parseFloat(document.getElementById('customHeight').value)
                        };
                    default:
                        return { width: 220, height: 160 };
                }
            }
            
            runTest() {
                const dims = this.getDisplayDimensions();
                const dpr = window.devicePixelRatio || 1;
                const browserZoom = this.getBrowserZoom();
                const effectiveDpr = dpr * browserZoom;
                
                this.log(`=== TEST START ===`);
                this.log(`Display Type: ${this.displayType}`);
                this.log(`Dimensions: ${dims.width}Ã—${dims.height}`);
                this.log(`DPR: ${dpr.toFixed(3)}`);
                this.log(`Browser Zoom: ${browserZoom.toFixed(3)}`);
                this.log(`Effective DPR: ${effectiveDpr.toFixed(3)}`);
                this.log('');
                
                // Test current rendering
                this.testCurrentRendering(dims, effectiveDpr);
                
                // Test crisp rendering
                this.testCrispRendering(dims, effectiveDpr);
                
                // Analyze results
                this.analyzeResults(dims, effectiveDpr);
            }
            
            testCurrentRendering(dims, effectiveDpr) {
                const { width, height } = dims;
                const dpr = window.devicePixelRatio || 1;
                
                // AGNOSTIC: Use actual DPR only, no browser zoom simulation
                this.currentCanvas.width = width * dpr;
                this.currentCanvas.height = height * dpr;
                this.currentCanvas.style.width = width + 'px';
                this.currentCanvas.style.height = height + 'px';
                
                // Scale context for DPR ONLY
                this.currentCtx.scale(dpr, dpr);
                
                // Draw like dayRangeMeter.js (current approach)
                this.drawCurrentDayRange(this.currentCtx, width, height, dpr);
                
                this.log(`CURRENT RENDERING (DPR ONLY):`);
                this.log(`  Device DPR: ${dpr.toFixed(3)}`);
                this.log(`  Canvas internal: ${this.currentCanvas.width}Ã—${this.currentCanvas.height}`);
                this.log(`  CSS display: ${width}Ã—${height}`);
                this.log(`  Font: '10px sans-serif' (in DPR-scaled context)`);
                this.log(`  Effective font size: ${(10 * dpr).toFixed(2)}px`);
                this.log('');
            }
            
            testCrispRendering(dims, effectiveDpr) {
                const { width, height } = dims;
                const dpr = window.devicePixelRatio || 1;
                
                // âœ… CORRECT: Ensure integer canvas dimensions for pixel-perfect rendering
                const integerCanvasWidth = Math.round(width * dpr);
                const integerCanvasHeight = Math.round(height * dpr);
                
                this.crispCanvas.width = integerCanvasWidth;
                this.crispCanvas.height = integerCanvasHeight;
                
                // Calculate integer CSS dimensions that match canvas internal dimensions
                const cssWidth = integerCanvasWidth / dpr;
                const cssHeight = integerCanvasHeight / dpr;
                
                this.crispCanvas.style.width = cssWidth + 'px';
                this.crispCanvas.style.height = cssHeight + 'px';
                
                // Scale context for DPR ONLY
                this.crispCtx.scale(dpr, dpr);
                
                // Draw with crisp fixes
                this.drawCrispDayRange(this.crispCtx, cssWidth, cssHeight, dpr);
                
                this.log(`CRISP RENDERING (PIXEL-PERFECT CANVAS):`);
                this.log(`  Device DPR: ${dpr.toFixed(3)}`);
                this.log(`  Original dims: ${width.toFixed(2)}Ã—${height.toFixed(2)}`);
                this.log(`  Canvas internal: ${integerCanvasWidth}Ã—${integerCanvasHeight} (INTEGER!)`);
                this.log(`  CSS display: ${cssWidth.toFixed(2)}Ã—${cssHeight.toFixed(2)}`);
                this.log(`  Font: ${this.calculateCrispFontSize(10, dpr).toFixed(2)}px sans-serif`);
                this.log(`  Font calculation: Math.round(10 Ã— ${dpr.toFixed(3)}) / ${dpr.toFixed(3)}`);
                this.log('');
            }
            
            drawCurrentDayRange(ctx, width, height, dpr) {
                // Clear canvas
                ctx.clearRect(0, 0, width, height);
                ctx.fillStyle = '#111827';
                ctx.fillRect(0, 0, width, height);
                
                // Apply sub-pixel alignment (current approach)
                ctx.save();
                ctx.translate(0.5, 0.5);
                
                // Draw ADR axis
                const adrAxisX = width * 0.65;
                ctx.strokeStyle = '#4B5563';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(adrAxisX, 0);
                ctx.lineTo(adrAxisX, height);
                ctx.stroke();
                
                // Draw price markers with current text rendering
                ctx.font = '10px sans-serif';
                ctx.fillStyle = '#9CA3AF';
                ctx.textAlign = 'right';
                ctx.textBaseline = 'middle';
                
                // Price labels
                const priceY = height / 2;
                const priceX = adrAxisX - 15;
                ctx.fillText('O 1.23456', priceX, priceY);
                ctx.fillText('H 1.23567', priceX, priceY - 20);
                ctx.fillText('L 1.23432', priceX, priceY + 20);
                
                ctx.restore();
            }
            
            drawCrispDayRange(ctx, width, height, dpr) {
                // Clear canvas
                ctx.clearRect(0, 0, width, height);
                ctx.fillStyle = '#111827';
                ctx.fillRect(0, 0, width, height);
                
                // Apply sub-pixel alignment
                ctx.save();
                ctx.translate(0.5, 0.5);
                
                // Draw ADR axis
                const adrAxisX = width * 0.65;
                ctx.strokeStyle = '#4B5563';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(adrAxisX, 0);
                ctx.lineTo(adrAxisX, height);
                ctx.stroke();
                
                // Draw price markers with CRISP text rendering
                const crispFontSize = this.calculateCrispFontSize(10, dpr);
                ctx.font = `${crispFontSize}px sans-serif`;
                ctx.fillStyle = '#9CA3AF';
                ctx.textAlign = 'right';
                ctx.textBaseline = 'middle';
                
                // Price labels with pixel-perfect positioning
                const priceY = height / 2;
                const priceX = this.calculateCrispPosition(adrAxisX - 15, dpr);
                const crispPriceY1 = this.calculateCrispPosition(priceY - 20, dpr);
                const crispPriceY2 = this.calculateCrispPosition(priceY + 20, dpr);
                const crispPriceY3 = this.calculateCrispPosition(priceY, dpr);
                
                ctx.fillText('O 1.23456', priceX, crispPriceY3);
                ctx.fillText('H 1.23567', priceX, crispPriceY1);
                ctx.fillText('L 1.23432', priceX, crispPriceY2);
                
                ctx.restore();
            }
            
            calculateCrispFontSize(baseFontSize, dpr) {
                // Pixel-perfect font sizing: Math.round(size Ã— DPR) / DPR
                return Math.round(baseFontSize * dpr) / dpr;
            }
            
            calculateCrispPosition(position, dpr) {
                // Pixel-perfect positioning: Math.round(pos Ã— DPR) / DPR
                return Math.round(position * dpr) / dpr;
            }
            
            analyzeResults(dims, dpr) {
                const { width, height } = dims;
                
                this.log(`CRISPNESS ANALYSIS:`);
                
                // Focus on font rendering crispness
                const currentFontSize = 10; // Fixed font size in dayRangeMeter.js
                const crispFontSize = this.calculateCrispFontSize(10, dpr);
                
                this.log(`  Display: ${this.displayType} (${width.toFixed(2)}Ã—${height.toFixed(2)})`);
                this.log(`  Device DPR: ${dpr.toFixed(3)}`);
                this.log(`  Canvas internal: ${(width * dpr).toFixed(0)}Ã—${(height * dpr).toFixed(0)}`);
                this.log(`  CSS display: ${width.toFixed(2)}Ã—${height.toFixed(2)}`);
                this.log('');
                
                // Text rendering analysis
                this.log(`TEXT RENDERING:`);
                this.log(`  Current approach: '${currentFontSize}px sans-serif' in DPR-scaled context`);
                this.log(`    Effective font size: ${(currentFontSize * dpr).toFixed(2)}px`);
                this.log(`  Crisp approach: '${crispFontSize.toFixed(2)}px sans-serif' (pixel-perfect)`);
                this.log(`    Font calculation: Math.round(${currentFontSize} Ã— ${dpr.toFixed(3)}) / ${dpr.toFixed(3)}`);
                this.log('');
                
                // Dimension analysis
                this.log(`DIMENSION ANALYSIS:`);
                const scaledWidth = width * dpr;
                const scaledHeight = height * dpr;
                const widthIsNearInteger = Math.abs(scaledWidth - Math.round(scaledWidth)) < 0.01;
                const heightIsNearInteger = Math.abs(scaledHeight - Math.round(scaledHeight)) < 0.01;
                
                this.log(`  Width Ã— ${dpr.toFixed(3)} = ${scaledWidth.toFixed(3)} ${widthIsNearInteger ? 'âœ… INTEGER' : 'âš ï¸ FRACTIONAL'}`);
                this.log(`  Height Ã— ${dpr.toFixed(3)} = ${scaledHeight.toFixed(3)} ${heightIsNearInteger ? 'âœ… INTEGER' : 'âš ï¸ FRACTIONAL'}`);
                this.log('');
                
                // Crispness prediction
                this.log(`CRISPNESS PREDICTION:`);
                if (widthIsNearInteger && heightIsNearInteger) {
                    this.log(`  âœ… BOTH dimensions pixel-perfect â†’ CRISP TEXT LIKELY`);
                } else if (widthIsNearInteger || heightIsNearInteger) {
                    this.log(`  âš ï¸ ONE dimension pixel-perfect â†’ MIXED CRISPNESS`);
                } else {
                    this.log(`  âŒ BOTH dimensions fractional â†’ BLURRY TEXT LIKELY`);
                }
                this.log(`  ðŸŽ¯ SOLUTION: Crisp approach guarantees pixel-perfect alignment`);
                this.log('');
            }
            
            log(message) {
                this.debugInfo.textContent += message + '\n';
                this.debugInfo.scrollTop = this.debugInfo.scrollHeight;
            }
            
            clearDebug() {
                this.debugInfo.textContent = '';
            }
        }
        
        // Initialize test when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new DayRangeCrispnessTest();
        });
    </script>
</body>
</html>

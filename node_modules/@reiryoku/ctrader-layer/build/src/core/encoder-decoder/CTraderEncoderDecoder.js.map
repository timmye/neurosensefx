{"version":3,"file":"CTraderEncoderDecoder.js","sourceRoot":"","sources":["../../../../src/core/encoder-decoder/CTraderEncoderDecoder.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;AAAA,mCAAgC;AAEhC,8EAAyE;AAEzE,MAAM,SAAS,GAAY,6CAAqB,CAAC,SAAS,EAAE,CAAC;AAE7D,MAAa,qBAAqB;IAM9B;QALA,oDAA6B;QAC7B,8CAAe;QACf,8CAAe;QACf,uDAA+C;QAG3C,uBAAA,IAAI,qCAAe,CAAC,MAAA,CAAC;QACrB,uBAAA,IAAI,+BAAS,SAAS,MAAA,CAAC;QACvB,uBAAA,IAAI,+BAAS,SAAS,MAAA,CAAC;QACvB,uBAAA,IAAI,wCAAkB,SAAS,MAAA,CAAC;IACpC,CAAC;IAEM,gBAAgB,CAAE,OAAsC;QAC3D,uBAAA,IAAI,wCAAkB,OAAO,MAAA,CAAC;IAClC,CAAC;IAEM,MAAM,CAAE,IAAmB;QAC9B,MAAM,cAAc,GAAG,IAAI,CAAC,QAAQ,EAAE,CAAC;QAEvC,IAAI,SAAS,EAAE;YACX,OAAO,cAAc,CAAC;SACzB;QAED,MAAM,UAAU,GAAW,uBAAA,IAAI,yCAAY,CAAC;QAC5C,MAAM,oBAAoB,GAAW,cAAc,CAAC,MAAM,CAAC;QAC3D,MAAM,IAAI,GAAG,eAAM,CAAC,KAAK,CAAC,UAAU,CAAC,CAAC;QAEtC,IAAI,CAAC,YAAY,CAAC,oBAAoB,EAAE,CAAC,CAAC,CAAC;QAE3C,OAAO,eAAM,CAAC,MAAM,CAAC,CAAE,IAAI,EAAE,cAAc,EAAG,EAAE,UAAU,GAAG,oBAAoB,CAAC,CAAC;IACvF,CAAC;IAEM,MAAM,CAAE,MAAc;QACzB,IAAI,SAAS,EAAE;YACX,IAAI,uBAAA,IAAI,4CAAe,EAAE;gBAErB,uBAAA,IAAI,4CAAe,MAAnB,IAAI,EAAgB,MAAM,CAAC,IAAI,CAAC,CAAC;aACpC;YAED,OAAO;SACV;QAED,MAAM,IAAI,GAAuB,uBAAA,IAAI,mCAAM,CAAC;QAC5C,IAAI,UAAU,GAAW,MAAM,CAAC;QAEhC,IAAI,uBAAA,IAAI,mCAAM,EAAE;YACZ,UAAU,GAAG,eAAM,CAAC,MAAM,CAAC,CAAE,uBAAA,IAAI,mCAAM,EAAE,UAAU,EAAG,EAAE,uBAAA,IAAI,mCAAM,CAAC,MAAM,GAAG,UAAU,CAAC,MAAM,CAAC,CAAC;YAE/F,uBAAA,IAAI,+BAAS,SAAS,MAAA,CAAC;SAC1B;QAED,IAAI,IAAI,EAAE;YACN,IAAI,UAAU,CAAC,MAAM,IAAI,IAAI,EAAE;gBAC3B,IAAI,uBAAA,IAAI,4CAAe,EAAE;oBACrB,uBAAA,IAAI,4CAAe,MAAnB,IAAI,EAAgB,UAAU,CAAC,KAAK,CAAC,CAAC,EAAE,IAAI,CAAC,CAAC,CAAC;iBAClD;gBAED,uBAAA,IAAI,+BAAS,SAAS,MAAA,CAAC;gBAEvB,IAAI,UAAU,CAAC,MAAM,KAAK,IAAI,EAAE;oBAC5B,IAAI,CAAC,MAAM,CAAC,UAAU,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC,CAAC;iBACvC;gBAED,OAAO;aACV;SACJ;aACI;YACD,IAAI,UAAU,CAAC,MAAM,IAAI,uBAAA,IAAI,yCAAY,EAAE;gBACvC,uBAAA,IAAI,+BAAS,UAAU,CAAC,YAAY,CAAC,CAAC,CAAC,MAAA,CAAC;gBAExC,IAAI,UAAU,CAAC,MAAM,KAAK,uBAAA,IAAI,yCAAY,EAAE;oBACxC,IAAI,CAAC,MAAM,CAAC,UAAU,CAAC,KAAK,CAAC,uBAAA,IAAI,yCAAY,CAAC,CAAC,CAAC;iBACnD;gBAED,OAAO;aACV;SACJ;QAED,uBAAA,IAAI,+BAAS,UAAU,MAAA,CAAC;IAC5B,CAAC;CACJ;AAjFD,sDAiFC","sourcesContent":["import { Buffer } from \"buffer\";\nimport { GenericObject } from \"#utilities/GenericObject\";\nimport { CTraderLayerUtilities } from \"#utilities/CTraderLayerUtilities\";\n\nconst isBrowser: boolean = CTraderLayerUtilities.isBrowser();\n\nexport class CTraderEncoderDecoder {\n    readonly #sizeLength: number;\n    #size?: number;\n    #tail?: Buffer;\n    #decodeHandler?: (...parameters: any[]) => any;\n\n    public constructor () {\n        this.#sizeLength = 4;\n        this.#size = undefined;\n        this.#tail = undefined;\n        this.#decodeHandler = undefined;\n    }\n\n    public setDecodeHandler (handler: (...parameters: any[]) => any): void {\n        this.#decodeHandler = handler;\n    }\n\n    public encode (data: GenericObject): Buffer {\n        const normalizedData = data.toBuffer();\n\n        if (isBrowser) {\n            return normalizedData;\n        }\n\n        const sizeLength: number = this.#sizeLength;\n        const normalizedDataLength: number = normalizedData.length;\n        const size = Buffer.alloc(sizeLength);\n\n        size.writeInt32BE(normalizedDataLength, 0);\n\n        return Buffer.concat([ size, normalizedData, ], sizeLength + normalizedDataLength);\n    }\n\n    public decode (buffer: Buffer): void {\n        if (isBrowser) {\n            if (this.#decodeHandler) {\n                // @ts-ignore\n                this.#decodeHandler(buffer.data);\n            }\n\n            return;\n        }\n\n        const size: number | undefined = this.#size;\n        let usedBuffer: Buffer = buffer;\n\n        if (this.#tail) {\n            usedBuffer = Buffer.concat([ this.#tail, usedBuffer, ], this.#tail.length + usedBuffer.length);\n\n            this.#tail = undefined;\n        }\n\n        if (size) {\n            if (usedBuffer.length >= size) {\n                if (this.#decodeHandler) {\n                    this.#decodeHandler(usedBuffer.slice(0, size));\n                }\n\n                this.#size = undefined;\n\n                if (usedBuffer.length !== size) {\n                    this.decode(usedBuffer.slice(size));\n                }\n\n                return;\n            }\n        }\n        else {\n            if (usedBuffer.length >= this.#sizeLength) {\n                this.#size = usedBuffer.readUInt32BE(0);\n\n                if (usedBuffer.length !== this.#sizeLength) {\n                    this.decode(usedBuffer.slice(this.#sizeLength));\n                }\n\n                return;\n            }\n        }\n\n        this.#tail = usedBuffer;\n    }\n}\n"]}